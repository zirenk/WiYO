{% extends "base.html" %}

{% block content %}
<h1>Demographics</h1>
<form id="demographics-form" method="POST" action="{{ url_for('demographics') }}">
    <div class="mb-3">
        <button type="button" id="edit-toggle" class="btn btn-primary" onclick="toggleEditMode()">
            {% if edit_mode %}Cancel Edit{% else %}Edit Demographics{% endif %}
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">Back to Dashboard</a>
    </div>
    <div id="form-message" class="alert" style="display: none;"></div>
    <div class="mb-3">
        <label for="age" class="form-label">Age</label>
        <input type="number" class="form-control" id="age" name="age" value="{{ user.demographics.age if user.demographics else '' }}" {% if not edit_mode %}readonly{% endif %} required>
    </div>
    <div class="mb-3">
        <label for="gender" class="form-label">Gender</label>
        <select class="form-select" id="gender" name="gender" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select gender</option>
            <option value="male" {% if user.demographics and user.demographics.gender == 'male' %}selected{% endif %}>Male</option>
            <option value="female" {% if user.demographics and user.demographics.gender == 'female' %}selected{% endif %}>Female</option>
            <option value="other" {% if user.demographics and user.demographics.gender == 'other' %}selected{% endif %}>Other</option>
            <option value="prefer_not_to_say" {% if user.demographics and user.demographics.gender == 'prefer_not_to_say' %}selected{% endif %}>Prefer not to say</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="education" class="form-label">Highest Level of Education</label>
        <select class="form-select" id="education" name="education" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select education level</option>
            <option value="high_school" {% if user.demographics and user.demographics.education == 'high_school' %}selected{% endif %}>High School</option>
            <option value="bachelors" {% if user.demographics and user.demographics.education == 'bachelors' %}selected{% endif %}>Bachelor's Degree</option>
            <option value="masters" {% if user.demographics and user.demographics.education == 'masters' %}selected{% endif %}>Master's Degree</option>
            <option value="phd" {% if user.demographics and user.demographics.education == 'phd' %}selected{% endif %}>Ph.D. or higher</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="employment" class="form-label">Employment Status</label>
        <select class="form-select" id="employment" name="employment" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select employment status</option>
            <option value="employed" {% if user.demographics and user.demographics.employment == 'employed' %}selected{% endif %}>Employed</option>
            <option value="unemployed" {% if user.demographics and user.demographics.employment == 'unemployed' %}selected{% endif %}>Unemployed</option>
            <option value="student" {% if user.demographics and user.demographics.employment == 'student' %}selected{% endif %}>Student</option>
            <option value="retired" {% if user.demographics and user.demographics.employment == 'retired' %}selected{% endif %}>Retired</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="marital_status" class="form-label">Marital Status</label>
        <select class="form-select" id="marital_status" name="marital_status" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select marital status</option>
            <option value="single" {% if user.demographics and user.demographics.marital_status == 'single' %}selected{% endif %}>Single</option>
            <option value="married" {% if user.demographics and user.demographics.marital_status == 'married' %}selected{% endif %}>Married</option>
            <option value="divorced" {% if user.demographics and user.demographics.marital_status == 'divorced' %}selected{% endif %}>Divorced</option>
            <option value="widowed" {% if user.demographics and user.demographics.marital_status == 'widowed' %}selected{% endif %}>Widowed</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="income" class="form-label">Annual Income</label>
        <select class="form-select" id="income" name="income" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select income range</option>
            <option value="0-25000" {% if user.demographics and user.demographics.income == '0-25000' %}selected{% endif %}>$0 - $25,000</option>
            <option value="25001-50000" {% if user.demographics and user.demographics.income == '25001-50000' %}selected{% endif %}>$25,001 - $50,000</option>
            <option value="50001-75000" {% if user.demographics and user.demographics.income == '50001-75000' %}selected{% endif %}>$50,001 - $75,000</option>
            <option value="75001-100000" {% if user.demographics and user.demographics.income == '75001-100000' %}selected{% endif %}>$75,001 - $100,000</option>
            <option value="100001+" {% if user.demographics and user.demographics.income == '100001+' %}selected{% endif %}>$100,001+</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="location" class="form-label">Location (City)</label>
        <input type="text" class="form-control" id="location" name="location" value="{{ user.demographics.location if user.demographics else '' }}" {% if not edit_mode %}readonly{% endif %} required>
    </div>
    <div class="mb-3">
        <label for="ethnicity" class="form-label">Ethnicity</label>
        <select class="form-select" id="ethnicity" name="ethnicity" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select ethnicity</option>
            <option value="white" {% if user.demographics and user.demographics.ethnicity == 'white' %}selected{% endif %}>White</option>
            <option value="black" {% if user.demographics and user.demographics.ethnicity == 'black' %}selected{% endif %}>Black or African American</option>
            <option value="asian" {% if user.demographics and user.demographics.ethnicity == 'asian' %}selected{% endif %}>Asian</option>
            <option value="hispanic" {% if user.demographics and user.demographics.ethnicity == 'hispanic' %}selected{% endif %}>Hispanic or Latino</option>
            <option value="other" {% if user.demographics and user.demographics.ethnicity == 'other' %}selected{% endif %}>Other</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="political_affiliation" class="form-label">Political Affiliation</label>
        <select class="form-select" id="political_affiliation" name="political_affiliation" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select political affiliation</option>
            <option value="democrat" {% if user.demographics and user.demographics.political_affiliation == 'democrat' %}selected{% endif %}>Democrat</option>
            <option value="republican" {% if user.demographics and user.demographics.political_affiliation == 'republican' %}selected{% endif %}>Republican</option>
            <option value="independent" {% if user.demographics and user.demographics.political_affiliation == 'independent' %}selected{% endif %}>Independent</option>
            <option value="other" {% if user.demographics and user.demographics.political_affiliation == 'other' %}selected{% endif %}>Other</option>
        </select>
    </div>
    <div class="mb-3">
        <label for="religion" class="form-label">Religion</label>
        <select class="form-select" id="religion" name="religion" {% if not edit_mode %}disabled{% endif %} required>
            <option value="">Select religion</option>
            <option value="christianity" {% if user.demographics and user.demographics.religion == 'christianity' %}selected{% endif %}>Christianity</option>
            <option value="islam" {% if user.demographics and user.demographics.religion == 'islam' %}selected{% endif %}>Islam</option>
            <option value="hinduism" {% if user.demographics and user.demographics.religion == 'hinduism' %}selected{% endif %}>Hinduism</option>
            <option value="buddhism" {% if user.demographics and user.demographics.religion == 'buddhism' %}selected{% endif %}>Buddhism</option>
            <option value="judaism" {% if user.demographics and user.demographics.religion == 'judaism' %}selected{% endif %}>Judaism</option>
            <option value="other" {% if user.demographics and user.demographics.religion == 'other' %}selected{% endif %}>Other</option>
            <option value="none" {% if user.demographics and user.demographics.religion == 'none' %}selected{% endif %}>None</option>
        </select>
    </div>
    <button type="submit" id="submit-button" class="btn btn-primary" {% if not edit_mode %}style="display: none;"{% endif %}>Submit Demographics</button>
</form>
{% endblock %}

{% block extra_js %}
<script>
let editMode = {{ edit_mode|tojson }};

function toggleEditMode(e) {
    if (e) e.preventDefault();
    editMode = !editMode;
    const form = document.getElementById('demographics-form');
    const editToggle = document.getElementById('edit-toggle');
    const submitButton = document.getElementById('submit-button');

    form.querySelectorAll('input, select').forEach(element => {
        if (element.id !== 'edit-toggle') {
            element.disabled = !editMode;
            if (element.tagName === 'INPUT') {
                element.readOnly = !editMode;
            }
        }
    });

    editToggle.textContent = editMode ? 'Cancel Edit' : 'Edit Demographics';
    submitButton.style.display = editMode ? 'block' : 'none';
}

function showMessage(message, type) {
    const messageElement = document.getElementById('form-message');
    messageElement.textContent = message;
    messageElement.className = `alert alert-${type}`;
    messageElement.style.display = 'block';
}

document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('demographics-form');
    const editToggle = document.getElementById('edit-toggle');

    if (editMode) {
        toggleEditMode();
    }

    editToggle.addEventListener('click', toggleEditMode);

    form.addEventListener('submit', function(e) {
        e.preventDefault();
        if (!editMode) {
            return;
        }
        
        const formData = new FormData(form);
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showMessage(data.message, 'success');
                toggleEditMode();
            } else {
                showMessage(data.error || 'Error updating demographics. Please try again.', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showMessage('An error occurred. Please try again.', 'danger');
        });
    });
});
</script>
{% endblock %}
